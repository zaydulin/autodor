{% extends 'site/useraccount/base.html' %}
{% load i18n %}
{% load static  %}
{% block title %}{{ seo_title }}{% endblock title %}
{% block description %}{{ seo_description }}{% endblock description %}
{% block propertytitle %}{% if seo_previev %}{{ seo_previev.url }} {% endif %} {% endblock propertytitle %}
{% block propertydescription %}{{ seo_propertytitle }}{% endblock propertydescription %}
{% block propertyimage %}{{ seo_propertydescription }}{% endblock propertyimage %}
{% block head %}
{% endblock head %}

<!-- ======================== Breadcrumb Three Section End ===================== -->

<!-- ===================== Profile Section Start ============================== -->
{% block content %}
<div class="tab-pane fade show active" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab" tabindex="0">
    <!-- Tab Content End -->
    <div class="row gy-4 list-grid-wrapper">
        {% if blog %}
        <div class="col-xl-8 col-sm-12">
            <iframe id="iframe" src="https://samo.vizor.company" style="width: 100%; height: 100%; border: none;min-height: 240px;" allowfullscreen="" data-userid="{{settings.description}}({{user.id}})"></iframe>
            <script>
                window.addEventListener("message", function(event) {
                  if (event.origin !== "https://samo.vizor.company") {
                    return;
                  }

                  if (event.data.request === "getUserId") {
                    const iframe = document.getElementById("iframe");
                    const userId = iframe.getAttribute("data-userid");

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º userId –æ–±—Ä–∞—Ç–Ω–æ –≤ iframe
                    iframe.contentWindow.postMessage({ userId: userId }, "https://samo.vizor.company");
                  }
                });
            </script>
            <script>
                window.addEventListener("message", function(event) {
                  console.log("üì• –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç iframe:", event.origin, event.data);

                  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ iframe
                  if (event.origin !== "https://samo.vizor.company") {
                    console.warn("‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç samo.vizor.company:", event.origin);
                    return;
                  }

                  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ userId
                  if (event.data.request === "getUserId") {
                    const iframe = document.getElementById("iframe");
                    if (!iframe) {
                      console.error("‚ùå iframe —Å id='iframe' –Ω–µ –Ω–∞–π–¥–µ–Ω.");
                      return;
                    }

                    const userId = iframe.getAttribute("data-userid");

                    if (!userId) {
                      console.warn("‚ö†Ô∏è –ê—Ç—Ä–∏–±—É—Ç data-userid –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ iframe.");
                    } else {
                      console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ userId –≤ iframe:", userId);
                    }

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º userId –æ–±—Ä–∞—Ç–Ω–æ –≤ iframe
                    iframe.contentWindow.postMessage(
                      { userId: userId || "userId –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" },
                      "https://stream.vizor.company"
                    );
                  }
                });
            </script>


        </div>
        <div class="col-xl-4 col-sm-12">
            <div class="common-sidebar-wrapper" style=" height: 70vh;">
                <div class="common-sidebar">
                    <h6 class="common-sidebar__title">
                        {% trans '–û–Ω–ª–∞–π–Ω' %}
                        <span class="notification" style="float: right;" id="online_count">
                                                0
                                            </span>
                    </h6>
                    <div id="messages-container">
                        <p>{% trans '–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π' %}...</p>
                    </div>
                </div>
                <div class="common-sidebar p-0 w-100" style=" position: absolute; bottom: 0; margin: -10px 10px 10px -25px; ">
                    <form id="message-form" autocomplete="off">
                        {% csrf_token %}
                        <div class="search-box w-75">
                            <textarea type="text" class="common-input border-0" id="message-input" placeholder="{% trans '–°–æ–æ–±—â–µ–Ω–∏–µ' %} ..." required style="height: 56px;"></textarea>
                            <button type="button" id="send-message" class="icon line-height-1 rounded-icon " style="right: -45px!important;
        background: #8f8e8e;">
                                <img src="{% static 'site/assets/images/icons/arrow-right-white.svg' %}" alt="">
                            </button>
                        </div>
                    </form>
                    <script>
                        document.addEventListener("DOMContentLoaded", function () {
                            const messageInput = document.getElementById("message-input");
                            const sendButton = document.getElementById("send-message");

                            messageInput.addEventListener("keydown", function (event) {
                                if (event.key === "Enter" && !event.shiftKey) {
                                    event.preventDefault();  // –æ—Ç–º–µ–Ω—è–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
                                    sendButton.click();     // –Ω–∞–∂–∏–º–∞–µ—Ç –Ω–∞ –∫–Ω–æ–ø–∫—É
                                }
                            });
                        });
                    </script>



                </div>
            </div>
        </div>
        {% else %}
        <p>{% trans '–ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –æ–Ω–ª–∞–π–Ω —Ç—Ä–µ–Ω–∏–Ω–≥–æ–≤' %}.</p>
        {% endif %}
    </div>
    <!-- Tab Content Start -->
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const blogId = Number("{{ blog.id|default:0 }}");
        const currentUserId = Number("{{ request.user.id|default:0 }}");

        console.log("Connecting to WebSocket for blog:", blogId);

    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const chatSocket = new WebSocket(
        `${protocol}://${window.location.host}/ws/blogs/${blogId}/chat/`
    );

        const messagesContainer = document.getElementById('messages-container');

        chatSocket.onopen = function() {
            console.log("‚úÖ WebSocket connected");
            messagesContainer.innerHTML = '';
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.error) {
                console.error("‚ùå Error from server:", data.error);
                return;
            }

            const messageHtml = `
            <div class="latest-blog">
                <div class="latest-blog__thumb">
                    <a><img src="/_media/default/user-nophoto.png" class="cover-img" alt="Avatar"></a>
                </div>
                <div class="latest-blog__content" style="display: grid;">
                    <span class="font-10" style="display: block;">
                        <span style="float:left;">${data.author}</span>
                        <span style="float:right; padding-right: 20px;">${data.date}</span>
                    </span>
                    <div class="latest-blog__title fw-500 font-body font-12">
                        ${data.content}
                    </div>
                </div>
            </div>`;

            messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
        };

        chatSocket.onerror = function(error) {
            console.error("‚ùå WebSocket error:", error);
        };

        chatSocket.onclose = function(e) {
            console.warn("‚ö†Ô∏è WebSocket closed:", e);
        };

        document.getElementById('send-message').addEventListener('click', function() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();

            if (message) {
                chatSocket.send(JSON.stringify({
                    'content': message,
                    'author_id': currentUserId
                }));
                messageInput.value = '';
            }
        });

        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('send-message').click();
            }
        });
    });

</script>
{% endblock content %}
