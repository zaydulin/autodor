{% extends 'site/useraccount/base.html' %}
{% load static %}
{% block title %}{{ seo_title }}{% endblock title %}
{% block description %}{{ seo_description }}{% endblock description %}
{% block propertytitle %}{% if seo_previev %}{{ seo_previev.url }} {% endif %} {% endblock propertytitle %}
{% block propertydescription %}{{ seo_propertytitle }}{% endblock propertydescription %}
{% block propertyimage %}{{ seo_propertydescription }}{% endblock propertyimage %}
{% block head %}{% endblock head %}

{% block content %}
<style>
    iframe {
    height: 500px;
    width: 100%;
    }
</style>
<div class="container py-4">
    <div class="row g-4">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <h2 class="mb-1">{{ advert.name }}</h2>
                    <div class="d-flex">
                        <div class="h4 text-primary fw-bold m-3">–°—Ç–æ–∏–º–æ—Å—Ç—å {{ advert.price }} {{ advert.currency }}</div>
                    </div>

                    <div class="row row-cols-2 row-cols-md-3 g-2 mb-3">
                        {% if advert.year %}<div class="col"><span class="badge bg-light text-dark spec-badge">–ì–æ–¥: {{ advert.year }}</span></div>{% endif %}
                        {% if advert.mileage %}<div class="col"><span class="badge bg-light text-dark spec-badge">–ü—Ä–æ–±–µ–≥: {{ advert.mileage }} –∫–º</span></div>{% endif %}
                        {% if advert.color %}<div class="col"><span class="badge bg-light text-dark spec-badge">–¶–≤–µ—Ç: {{ advert.color }}</span></div>{% endif %}
                        {% if advert.doors %}<div class="col"><span class="badge bg-light text-dark spec-badge">–î–≤–µ—Ä–µ–π: {{ advert.doors }}</span></div>{% endif %}
                        {% if advert.engine_volume %}<div class="col"><span class="badge bg-light text-dark spec-badge">–û–±—ä—ë–º: {{ advert.engine_volume }} –ª</span></div>{% endif %}
                        {% if advert.power %}<div class="col"><span class="badge bg-light text-dark spec-badge">–ú–æ—â–Ω.: {{ advert.power }} –ª.—Å.</span></div>{% endif %}
                        {% if advert.transmission %}<div class="col"><span class="badge bg-light text-dark spec-badge">–ö–æ—Ä–æ–±–∫–∞: {{ advert.get_transmission_display }}</span></div>{% endif %}
                        {% if advert.fuel %}<div class="col"><span class="badge bg-light text-dark spec-badge">–¢–æ–ø–ª–∏–≤–æ: {{ advert.get_fuel_display }}</span></div>{% endif %}
                        {% if advert.drive %}<div class="col"><span class="badge bg-light text-dark spec-badge">–ü—Ä–∏–≤–æ–¥: {{ advert.get_drive_display }}</span></div>{% endif %}
                    </div>

                    {% if advert.images %}
                    <div id="advCarousel" class="carousel slide gallery mb-3" data-bs-ride="carousel">
                        <div class="carousel-inner rounded">
                            {% for img in advert.images %}
                            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                <img src="{{ img }}" class="d-block w-100" alt="{{ advert.name }}">
                            </div>
                            {% endfor %}
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#advCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#advCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ -->
            <div class="row mt-1">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header"><h5 class="mb-0">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</h5></div>
                        <div class="card-body">
                            <iframe class="osm-iframe" src="https://www.openstreetmap.org/export/embed.html?bbox=37.6173,55.7558,37.6173,55.7558&layer=mapnik&marker=55.7558,37.6173"></iframe>
                            <div class="small text-muted mt-2">–ú–æ—Å–∫–≤–∞, –ö—Ä–∞—Å–Ω–∞—è –ø–ª–æ—â–∞–¥—å</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="col-lg-4" id="sidebar-container">
            <div class="d-grid gap-2">
                <button class="btn btn-light border" data-bs-toggle="offcanvas" data-bs-target="#offcanvasCalls">‚òéÔ∏è –ó–≤–æ–Ω–∫–∏</button>
                <button class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#offcanvasChat">üí¨ –ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç</button>
                {% if request.user in application.user_menager.all %}
                <button class="btn btn-primary" id="edit-sidebar-btn">–í–Ω–µ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                {% endif %}
            </div>

            <!-- –ó–∞—è–≤–∫–∞ -->
            <div class="card mb-4"  id="sidebar">
                <div class="card-header"><h5 class="mb-0">–ó–∞—è–≤–∫–∞ {{ application.id }}</h5></div>
                <div class="card-body">
                    <div class="mb-2"><strong>–°—Ç–∞—Ç—É—Å:</strong> {{ application.get_status_display }}</div>
                    <div class="mb-2"><strong>–°–æ–∑–¥–∞–Ω–∞: </strong>{{ application.created_at|date:"d.m.Y H:i" }}</div>
                    <hr>
                    <div class="mb-2"><strong>–ó–∞–∫–∞–∑—á–∏–∫:</strong></div>
                    <ul class="list-unstyled mb-0">
                        <li class="d-flex align-items-center gap-2 mb-2">
                            <span class="avatar">{{ application.user.first.first_name|slice:":1" }}</span>
                            <div><div class="fw-semibold">{{ application.user.first.first_name }} {{ application.user.first.last_name }}</div><div class="small text-muted"> {{ application.user.first.email }}</div></div>
                        </li>
                    </ul>

                    <!-- –ú–µ–Ω–µ–¥–∂–µ—Ä—ã -->
                    <div class="mb-2"><strong>–ú–µ–Ω–µ–¥–∂–µ—Ä—ã:</strong></div>
                    <ul class="list-unstyled mb-0">
                        {% for men in application.user_menager.all %}
                            <li class="d-flex align-items-center gap-2 mb-2">
                                <span class="avatar">{{ men.first_name|slice:":1" }}</span>
                                <div><div class="fw-semibold">{{ men.first_name }} {{ men.last_name }}</div><div class="small text-muted">{{ men.email }}</div></div>
                            </li>
                        {% endfor %}
                    </ul>
                    <div class="mb-2"><strong>–í–æ–¥–∏—Ç–µ–ª–∏:</strong></div>
                    <ul class="list-unstyled mb-0">
                        {% for men in application.user_drivers.all %}
                            <li class="d-flex align-items-center gap-2 mb-2">
                                <span class="avatar">{{ men.first_name|slice:":1" }}</span>
                                <div><div class="fw-semibold">{{ men.first_name }} {{ men.last_name }}</div><div class="small text-muted">{{ men.email }}</div></div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ -->
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0">–î–æ–∫—É–º–µ–Ω—Ç—ã</h5></div>
                <div class="card-body">
                    <ul class="list-group">
                        <li class="list-group-item d-flex align-items-center justify-content-between">
                            <div>
                                <i class="bi bi-file-earmark-text me-2 text-primary"></i> –î–æ–≥–æ–≤–æ—Ä.pdf
                            </div>
                            <a href="#" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-download"></i>–ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
                            </a>
                        </li>
                        <li class="list-group-item d-flex align-items-center justify-content-between">
                            <div>
                                <i class="bi bi-file-earmark-image me-2 text-success"></i> –§–æ—Ç–æ_–∞–≤—Ç–æ.jpg
                            </div>
                            <a href="#" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-download"></i>–ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- –†–∞—Å—Ö–æ–¥—ã -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">–†–∞—Å—Ö–æ–¥—ã</h5>
                    <span style="padding: 10px;" class="badge bg-primary">–ò—Ç–æ–≥–æ: {{ total_price }} ‚ÇΩ</span>
                </div>
                <div class="card-body">
                    <table class="table table-sm align-middle">
                        <thead>
                        <tr><th>–°—Ç–∞—Ç—å—è</th><th class="text-end">–°—É–º–º–∞</th><th>–î–∞—Ç–∞</th></tr>
                        </thead>
                        <tbody>
                        <tr><td>–°–≤–æ—è –°—Ç–æ–∏–º–æ—Å—Ç—å</td><td class="text-end">{{ application.price }} ‚ÇΩ</td><td>{{ application.created_at|date:"d.m.Y" }}</td></tr>
                        {% for expense in expenses %}
                            <tr><td>{{ expense.title }}</td><td class="text-end">{{ expense.amount }} ‚ÇΩ</td><td>{{ expense.created_at|date:"d.m.Y" }}</td></tr>
                        {% endfor %}
                        <form action=""></form>
                            <tr style="display: none"><td></td><td class="text-end">{{ expense.amount }} ‚ÇΩ</td><td>{{ expense.created_at|date:"d.m.Y" }}</td></tr>
                        </form>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Offcanvas: –ó–≤–æ–Ω–∫–∏ -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasCalls">
    <div class="offcanvas-header">
        <h5>–ó–≤–æ–Ω–∫–∏</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <!-- –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
        <h6 class="mb-3">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h6>
        <ul class="list-group mb-4">
            {% for user in users %}
            <li class="list-group-item d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <img src="{{ user.avatar.url }}" class="rounded-circle me-2" alt="–ê–≤–∞—Ç–∞—Ä –ò–≤–∞–Ω" height="32px">
                    <span>{{user.first_name}} {{user.last_name}}</span>
                </div>
                <button id="callButton" class="btn btn-success">
                    <i class="bi bi-telephone-fill"></i> –ü–æ–∑–≤–æ–Ω–∏—Ç—å
                </button>
                <button onclick="hangup()" class="btn btn-danger" style="display: none;" id="hangupButton">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>

            </li>
            {% endfor %}
        </ul>

        <!-- –ò—Å—Ç–æ—Ä–∏—è –∑–≤–æ–Ω–∫–æ–≤ -->
        <h6 class="mb-3">–ò—Å—Ç–æ—Ä–∏—è –∑–≤–æ–Ω–∫–æ–≤</h6>
        <ul class="list-group">
            {% for call in calls %}
            <li class="list-group-item">
                {{ call.created_at|date:"d.m.Y H:i" }} ‚Äî
                {% if call.is_active %}–ê–∫—Ç–∏–≤–µ–Ω{% else %}–ó–∞–≤–µ—Ä—à–µ–Ω{% endif %}
            </li>
            {% empty %}
            <li class="list-group-item">–ù–µ—Ç –∑–≤–æ–Ω–∫–æ–≤</li>
            {% endfor %}
        </ul>
    </div>
</div>

<!-- Offcanvas: –ß–∞—Ç -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasChat">
    <div class="offcanvas-header">
        <h5>–ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column">
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div class="flex-grow-1 overflow-auto border rounded p-2 mb-2" style="min-height:260px;" id="group-chat-messages">
            {% for message in messages %}
                {% if message.author != request.user %}
                <div class="d-flex mb-2" data-message-id="{{ message.id }}">
                    <div class="bg-primary text-white p-2 rounded" style="max-width: 75%;">
                        <div class="fw-bold small">{{ message.author.first_name }} {{ message.author.last_name }}</div>
                        <div>{{ message.content }}</div>
                        <div class="small text-end text-muted">{{ message.date|date:"d.m H:i" }}</div>
                    </div>
                </div>
                {% else %}
                <div class="d-flex justify-content-end mb-2" data-message-id="{{ message.id }}">
                    <div class="bg-light p-2 rounded" style="max-width: 75%;">
                        <div class="fw-bold small">{{ message.author.first_name }} {{ message.author.last_name }}</div>
                        <div>{{ message.content }}</div>
                        <div class="small text-end text-muted">{{ message.date|date:"d.m H:i" }}</div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>

        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∞ -->
        <form class="d-flex gap-2" id="group-chat-form">
            {% csrf_token %}
            <input type="text" id="group-chat-input" class="form-control" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶">
            <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
<input type="hidden" id="last-message-id" name="last-message-id" value="{{ last_message_id }}">

    </div>
</div>



<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ -->
<div class="modal fade" id="editApplicationModal" tabindex="-1" aria-labelledby="editApplicationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editApplicationModalLabel">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞—è–≤–∫—É</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
      </div>
      <div class="modal-body">
        <form id="edit-application-form">
          {% csrf_token %}

          <!-- –ü–æ–ª–µ –¥–ª—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ -->
          <div class="mb-3">
            <label for="edit-price" class="form-label">–°–≤–æ—è —Ü–µ–Ω–∞</label>
            <input type="text" class="form-control" id="edit-price" name="price">
          </div>

          <!-- –ü–æ–ª–µ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ -->
          <div class="mb-3">
            <label for="edit-status" class="form-label">–°—Ç–∞—Ç—É—Å</label>
            <select class="form-select" id="edit-status" name="status">
              {% for key, value in application.Status.choices %}
                <option value="{{ key }}">{{ value }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- –í—ã–±–æ—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ -->
          <div class="mb-3">
            <label for="edit-managers" class="form-label">–ú–µ–Ω–µ–¥–∂–µ—Ä—ã</label>
            <select multiple class="form-select" id="edit-managers" name="user_menager">
              {% for manager in all_managers %}
                <option value="{{ manager.id }}">{{ manager.first_name }} {{ manager.last_name }} ({{ manager.email }})</option>
              {% endfor %}
            </select>
          </div>

          <!-- –í—ã–±–æ—Ä –≤–æ–¥–∏—Ç–µ–ª–µ–π -->
          <div class="mb-3">
            <label for="edit-drivers" class="form-label">–í–æ–¥–∏—Ç–µ–ª–∏</label>
            <select multiple class="form-select" id="edit-drivers" name="user_drivers">
              {% for driver in all_drivers %}
                <option value="{{ driver.id }}">{{ driver.first_name }} {{ driver.last_name }} ({{ driver.email }})</option>
              {% endfor %}
            </select>
          </div>

        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" id="save-changes-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
    const toggle = document.getElementById("toggle-desc");
    if (toggle) {
        toggle.addEventListener("click", function (e) {
            e.preventDefault();
            const moreText = document.getElementById("more-text");
            const p = document.getElementById("description-text");

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏
            if (moreText.style.display === "none") {
                moreText.style.display = "inline";
                p.innerHTML = moreText.innerHTML + ' <a href="#" id="toggle-desc">–°–∫—Ä—ã—Ç—å</a>';
            } else {
                moreText.style.display = "none";
                p.innerHTML = p.innerHTML.split('<a')[0] + ' <a href="#" id="toggle-desc">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é</a>';
            }
        });
    }
});

</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const chatContainer = document.getElementById('group-chat-messages');
    const messageInput = document.getElementById('group-chat-input');
    const messageForm = document.getElementById('group-chat-form');

    // –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é lastMessageId –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è
    let lastMessageId = document.getElementById('last-message-id') ? document.getElementById('last-message-id').value : null;

    // –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ, –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ —à–∞–±–ª–æ–Ω
    // –ù–∞–ø—Ä–∏–º–µ—Ä, –≤–Ω—É—Ç—Ä–∏ —Ñ–æ—Ä–º—ã:
    // <input type="hidden" id="last-message-id" name="last-message-id" value="{{ last_message_id }}">

    const csrfToken = document.querySelector('form#group-chat-form input[name="csrfmiddlewaretoken"]').value;

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const content = messageInput.value.trim();
        if (!content) return;

        $.ajax({
            url: "{% url 'moderation:send_message' application.id %}", // –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —É—Ä–ª
            type: "POST",
            headers: {'X-CSRFToken': csrfToken},
            data: {
                content: content
            },
            success: function(data) {
                const html = `
                    <div class="d-flex justify-content-end mb-2" data-message-id="${data.id}">
                        <div class="bg-light p-2 rounded" style="max-width: 75%;">
                            <div class="fw-bold small">{{ request.user.first_name }} {{ request.user.last_name }}</div>
                            <div>${data.content}</div>
                            <div class="small text-end text-muted">${data.date}</div>
                        </div>
                    </div>
                `;
                chatContainer.insertAdjacentHTML('beforeend', html);
                messageInput.value = '';
                chatContainer.scrollTop = chatContainer.scrollHeight;
                lastMessageId = data.id;
                if (document.getElementById('last-message-id')) {
                    document.getElementById('last-message-id').value = lastMessageId;
                }
            },
            error: function() {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è.');
            }
        });
    });

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    function fetchNewMessages() {
        $.ajax({
            url: "{% url 'moderation:get_new_messages' application.id %}", // –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —É—Ä–ª
            type: "GET",
            data: {
                last_message_id: lastMessageId
            },
            success: function(data) {
                data.messages.forEach(function(msg) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ
                    if ($('#group-chat-messages div[data-message-id="' + msg.id + '"]').length === 0) {
                        // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
                        if (msg.author !== "{{ request.user.username }}") {
                            const html = `
                                <div class="d-flex mb-2" data-message-id="${msg.id}">
                                    <div class="bg-primary text-white p-2 rounded" style="max-width: 75%;">
                                        <div class="fw-bold small">${msg.author}</div>
                                        <div>${msg.content}</div>
                                        <div class="small text-end text-muted">${msg.date}</div>
                                    </div>
                                </div>
                            `;
                            chatContainer.insertAdjacentHTML('beforeend', html);
                            lastMessageId = msg.id;
                            if (document.getElementById('last-message-id')) {
                                document.getElementById('last-message-id').value = lastMessageId;
                            }
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                        }
                    }
                });
            }
        });
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
    setInterval(fetchNewMessages, 3000);
});

let localStream;
let peerConnection;
const servers = {
    iceServers: [
        {urls: 'stun:stun.l.google.com:19302'},
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å TURN-—Å–µ—Ä–≤–µ—Ä—ã
    ]
};

let websocket;
let callId;

function startWebRTC(callId) {
    // –ü–æ–ª—É—á–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫
    navigator.mediaDevices.getUserMedia({video: true, audio: true})
        .then(stream => {
            localStream = stream;
            // –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≤–æ–µ–≥–æ –≤–∏–¥–µ–æ

            // –°–æ–∑–¥–∞—Ç—å PeerConnection
            peerConnection = new RTCPeerConnection(servers);

            // –î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–∏ –º–µ–¥–∏–∞-–ø–æ—Ç–æ–∫–∏
            stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    sendSignal({'type': 'ice', 'candidate': event.candidate});
                }
            };

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤
            peerConnection.ontrack = event => {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
            };

            // –°–æ–∑–¥–∞—Ç—å –æ—Ñ—Ñ–µ—Ä
            peerConnection.createOffer()
                .then(offer => {
                    return peerConnection.setLocalDescription(offer);
                })
                .then(() => {
                    sendSignal({'type': 'offer', 'sdp': peerConnection.localDescription});
                });

        });
}

function sendSignal(message) {
    if (websocket && websocket.readyState === WebSocket.OPEN) {
        websocket.send(JSON.stringify(message));
    } else {
        console.warn('WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è');
        // –ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –∏–ª–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        setTimeout(() => {
            if (websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify(message));
            } else {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ.');
            }
        }, 1000);
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π WebSocket
function handleSignal(message) {
    const data = JSON.parse(message.data);
    if (data.type === 'offer') {
        // –ü–æ–ª—É—á–∏–ª–∏ –æ—Ñ—Ñ–µ—Ä, —Å–æ–∑–¥–∞–µ–º –æ—Ç–≤–µ—Ç
        peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp))
            .then(() => navigator.mediaDevices.getUserMedia({video: true, audio: true}))
            .then(stream => {
                localStream = stream;
                return peerConnection.createAnswer();
            })
            .then(answer => {
                return peerConnection.setLocalDescription(answer);
            })
            .then(() => {
                sendSignal({'type': 'answer', 'sdp': peerConnection.localDescription});
            });
    } else if (data.type === 'answer') {
        peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
    } else if (data.type === 'ice') {
        peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
    } else if (data.type === 'hangup') {
        // –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫
        if (peerConnection) {
            peerConnection.close();
        }
        if (websocket) {
            websocket.close();
        }
        alert('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
        document.getElementById('hangupButton').classList.add('d-none');
    }
}

function connectWebSocket(callId) {
    const wsUrl = `ws://${location.host}/ws/call/${callId}/`;
    websocket = new WebSocket(wsUrl);

    websocket.onopen = () => {
        console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
        startWebRTC(callId);
    };

    websocket.onclose = () => {
        console.log('WebSocket –∑–∞–∫—Ä—ã—Ç, –ø–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
        // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            connectWebSocket(callId);
        }, 3000);
    };

    websocket.onmessage = handleSignal;
    websocket.onerror = (err) => {
        console.error('WebSocket –æ—à–∏–±–∫–∞:', err);
    };
}

// –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –∑–≤–æ–Ω–æ–∫
function initiateCall(callId) {
    connectWebSocket(callId);
}

// –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫
function hangup() {
    sendSignal({'type': 'hangup'});
    if (peerConnection) {
        peerConnection.close();
    }
    if (websocket) {
        websocket.close();
    }
    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    document.getElementById('hangupButton').style.display = "none";
    document.getElementById("callButton").style.display = "inline";

}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü–æ–∑–≤–æ–Ω–∏—Ç—å"
document.addEventListener("DOMContentLoaded", () => {
    const callBtn = document.getElementById("callButton");
    if (callBtn) {
        callBtn.addEventListener("click", () => {
            fetch("{% url 'moderation:start_call' application.id %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: '{}'
            })
            .then(response => response.json())
            .then(data => {
                if (data.call_id) {
                    callId = data.call_id;
                    initiateCall(callId);
                    // –ú–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞
                    callBtn.style.display = 'none';
                    document.getElementById('hangupButton').style.display = "inline";
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–≤–æ–Ω–∫–∞');
                }
            });
        });
    }
    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞
});

</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  let isEditing = false;
  const sidebar = document.getElementById('sidebar');
  const editBtn = document.getElementById('edit-sidebar-btn');

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  document.querySelectorAll('.edit-toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const fieldDiv = btn.closest('.card');
      const fieldName = fieldDiv.dataset.field;
      toggleEditMode(fieldDiv, true);
    });
  });

  // –í–Ω–µ—Å–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
  document.addEventListener('click', (e) => {
    if (isEditing && !sidebar.contains(e.target) && !e.target.closest('.edit-toggle')) {
      // —Å–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      const data = {};
      document.querySelectorAll('#sidebar .card').forEach(card => {
        const field = card.dataset.field;
        const viewSpan = card.querySelector('.view-mode');
        const select = card.querySelector('select');
        data[field] = select.classList.contains('d-none') ? viewSpan.innerText : select.value;
      });
      // –æ—Ç–ø—Ä–∞–≤–∫–∞ AJAX
      saveChanges(data);
      toggleEditModeOff();
    }
  });

  function toggleEditMode(card, enable) {
    const viewSpan = card.querySelector('.view-mode');
    const select = card.querySelector('select');
    if (enable) {
      viewSpan.classList.add('d-none');
      select.classList.remove('d-none');
      // –ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –∫–Ω–æ–ø–∫—É "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" –Ω–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
      card.querySelector('.edit-toggle').innerText = '–ì–æ—Ç–æ–≤–æ';
    } else {
      viewSpan.classList.remove('d-none');
      select.classList.add('d-none');
      card.querySelector('.edit-toggle').innerText = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
    }
  }

  function toggleEditModeOff() {
    document.querySelectorAll('.card').forEach(card => {
      toggleEditMode(card, false);
    });
    isEditing = false;
  }

  // AJAX-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
  function saveChanges(data) {
    fetch("{% url 'moderation:update_application' application.id %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        for (const field in result.updated_fields) {
          const card = document.querySelector(`.card[data-field="${field}"]`);
          if (card) {
            const viewSpan = card.querySelector('.view-mode');
            viewSpan.innerText = result.updated_fields[field];
            toggleEditMode(card, false);
          }
        }
      } else {
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      }
    })
    .catch(() => {
      alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
    });
  }
});
</script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modal = new bootstrap.Modal(document.getElementById('editApplicationModal'));
    const form = document.getElementById('edit-application-form');
    const saveBtn = document.getElementById('save-changes-btn');

    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID –∑–∞—è–≤–∫–∏
    let currentApplicationId = "{{ application.id }}";

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–í–Ω–µ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
    document.getElementById('edit-sidebar-btn')?.addEventListener('click', () => {
      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ç–µ–∫—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
      // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –µ—Å—Ç—å —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è, –º–æ–∂–Ω–æ –∏—Ö –≤—Å—Ç–∞–≤–∏—Ç—å —Å—é–¥–∞
      document.getElementById('edit-price').value = "{{ application.price }}";

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å
      document.getElementById('edit-status').value = "{{ application.status }}";

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ (–≤—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, —á—Ç–æ –µ—Å—Ç—å —É –∑–∞—è–≤–∫–∏)
      const managerIds = [{% for m in application.user_menager.all %}'{{ m.id }}',{% endfor %}];
      const managerSelect = document.getElementById('edit-managers');
      Array.from(managerSelect.options).forEach(option => {
        option.selected = managerIds.includes(option.value);
      });

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤–æ–¥–∏—Ç–µ–ª–µ–π
      const driverIds = [{% for d in application.user_drivers.all %}'{{ d.id }}',{% endfor %}];
      const driverSelect = document.getElementById('edit-drivers');
      Array.from(driverSelect.options).forEach(option => {
        option.selected = driverIds.includes(option.value);
      });

      // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      modal.show();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
    saveBtn?.addEventListener('click', () => {
      // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      const data = {
        price: document.getElementById('edit-price').value,
        status: document.getElementById('edit-status').value,
        user_menager: Array.from(document.getElementById('edit-managers').selectedOptions).map(opt => opt.value),
        user_drivers: Array.from(document.getElementById('edit-drivers').selectedOptions).map(opt => opt.value),
      };

      fetch("{% url 'moderation:update_application' application.id %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(result => {
        if (result.success) {
          // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Ç–æ–∏–º–æ—Å—Ç—å)
          // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –ø–æ–ª–µ–π –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
          alert('–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
          // –û–±–Ω–æ–≤–∏—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          // –ù–∞–ø—Ä–∏–º–µ—Ä:
          // document.querySelector('.cost-display').innerText = data.price;

          modal.hide();
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + result.error);
        }
      })
      .catch(() => {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
      });
    });
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const address = "{{ advert.address|escapejs }}"; // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    const iframe = document.querySelector('.osm-iframe');

    if (address && iframe) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º API Nominatim –¥–ª—è –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`)
        .then(response => response.json())
        .then(data => {
          if (data && data.length > 0) {
            const lat = data[0].lat;
            const lon = data[0].lon;
            // –û–±–Ω–æ–≤–ª—è–µ–º src iframe —Å –Ω–æ–≤—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
            iframe.src = `https://www.openstreetmap.org/export/embed.html?bbox=${lon},${lat},${lon},${lat}&layer=mapnik&marker=${lat},${lon}`;

            // –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å—å
            document.querySelector('.card-body .small.text-muted').innerText = address;
          } else {
            console.warn('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ –∞–¥—Ä–µ—Å—É –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
          }
        })
        .catch(error => {
          console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
        });
    }
  });
</script>

{% endblock %}
