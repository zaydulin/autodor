{% extends 'site/useraccount/base.html' %}
  {% load static  %}
  {% load i18n %}
  {% block title %}Аудиозвонок с {{ other_user.username }}{% endblock title %}
  {% block description %}{{ seo_description }}{% endblock description %}
  {% block propertytitle %}{% if seo_previev %}{{ seo_previev.url }} {% endif %} {% endblock propertytitle %}
  {% block propertydescription %}{{ seo_propertytitle }}{% endblock propertydescription %}
  {% block propertyimage %}{{ seo_propertydescription }}{% endblock propertyimage %}
  {% block head %}


  {% endblock head %}
{% block content %}

  <style>


    h1 {
      font-size: 24px;
      margin-bottom: 10px;
      color: #2c3e50;
      text-align: center;
    }

    /* Статус звонка */
    #callStatus {
      font-size: 16px;
      margin-bottom: 20px;
      font-weight: bold;
      color: #2980b9;
      text-align: center;
    }

    /* Контейнер участников */
    #participants {
      display: flex;
      gap: 40px;
      margin-bottom: 30px;
      width: 100%;
      justify-content: center;
    }

    /* Блок участника */
    .participant {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      border-radius: 20px;
      border: 2px solid transparent;
      transition: border 0.3s, box-shadow 0.3s;
      cursor: default;
      width: 180px;
      font-size: 18px;
    }

    /* Аватарка */
    .avatar-call {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      overflow: hidden;
      margin-bottom: 15px;
      border: 3px solid transparent;
    }

    .avatar-call img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Имя участника */
    .name {
      font-weight: bold;
      font-size: 20px;
      margin-bottom: 10px;
      text-align: center;
    }

    /* Подсветка говорящего */
    .participant.active {
      border-color: #27ae60;
      box-shadow: 0 0 20px rgba(39, 174, 96, 0.6);
    }

    /* Область для кнопок */
    #call-controls {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* Стиль кнопок */
    button {
      padding: 14px 28px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
    }

    #callBtn {
      background-color: #2980b9;
      color: #fff;
    }

    #cancelBtn {
      background-color: #c0392b;
      color: #fff;
    }

    #muteBtn {
      background-color: #f39c12;
      color: #fff;
    }

    /* hover эффект */
    button:hover {
      opacity: 0.9;
      transform: scale(1.05);
    }

    button:active {
      transform: scale(0.98);
    }

    /* Скрытые аудио элементы */
    audio {
      display: none;
    }
  </style>
  <h1>Аудиозвонок с {{ other_user.username }}</h1>
  <!-- Статус звонка -->
  <div id="callStatus">Ожидание начала звонка...</div>

  <!-- Блок участников -->
  <div id="participants">
    <div id="caller" class="participant" data-user-id="{{ user.id }}">
      <div class="avatar-call"><img src="{{ user.avatar.url }}" alt="Аватар вызвавшего" /></div>
      <div class="name">{{ user.username }}</div>
    </div>
    <div id="callee" class="participant" data-user-id="{{ other_user.id }}">
      <div class="avatar-call"><img src="{{ other_user.avatar.url }}" alt="Аватар вызываемого" /></div>
      <div class="name">{{ other_user.username }}</div>
    </div>
  </div>

  <!-- Кнопки управления -->
  <div id="call-controls">
    <button id="callBtn">Начать звонок</button>
    <button id="cancelBtn" style="display:none;">Скинуть</button>
    <button id="muteBtn" style="display:none;">Выключить микрофон</button>
  </div>

  <!-- Аудио элементы -->
  <audio id="localAudio" autoplay muted></audio>
  <audio id="remoteAudio" autoplay></audio>

<script>
  const callId = "{{ call_id }}";
  const userId = "{{ user.id }}";
  const otherUserId = "{{ other_user.id }}";

<!--  const wsUrl = `ws://${location.host}/ws/call/${callId}/`;-->
  const ws = new WebSocket('wss://bahtrucks.com/ws/call/510cc83d-af54-420a-8f75-b18f2f5f9f16/');
  ws.onopen = () => console.log('Open');
  ws.onerror = (e) => console.error('Error', e);
  let localStream;
  let peerConnection;
  let isWebSocketOpen = false;
  const messageQueue = [];

  const callerDiv = document.getElementById('caller');
  const calleeDiv = document.getElementById('callee');

  const participants = {
    [userId]: callerDiv,
    [otherUserId]: calleeDiv
  };

  // Элементы интерфейса
  const callBtn = document.getElementById('callBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const muteBtn = document.getElementById('muteBtn');
  const callStatusDiv = document.getElementById('callStatus');
  console.log(cancelBtn)
  // Функции обновления статуса
  function updateCallStatus(message) {
    callStatusDiv.textContent = message;
  }

  function updateUIOnCallStart() {
    console.log(cancelBtn)

    if (callBtn) callBtn.style.display = 'none';
    if (cancelBtn) {
      cancelBtn.style.display = 'inline-block';
      cancelBtn.style.display = 'inline-block';
    }
    if (muteBtn) {
      muteBtn.style.display = 'inline-block';
      muteBtn.textContent = "Выключить микрофон";
    }
    updateCallStatus("Звонок активен");
  }

  function updateUIOnCallEnd() {
    if (callBtn) callBtn.style.display = 'inline-block';
    if (cancelBtn) {
      cancelBtn.style.display = 'none';
    }
    if (muteBtn) {
      muteBtn.style.display = 'none';
    }
    updateCallStatus("Звонок завершен");
  }

  // Функция подсветки говорящего
  function highlightSpeaker(userId) {
    Object.values(participants).forEach(div => {
      div.classList.remove('active');
    });
    if (participants[userId]) {
      participants[userId].classList.add('active');
    }
  }

  // Отправка сообщений через WebSocket
  function sendMessage(data) {
    const jsonData = JSON.stringify(data);
    if (isWebSocketOpen) {
      ws.send(jsonData);
    } else {
      messageQueue.push(jsonData);
    }
  }

  // Обработка WebSocket
  ws.onopen = () => {
    console.log('WebSocket connection opened');
    isWebSocketOpen = true;
    while (messageQueue.length > 0) {
      ws.send(messageQueue.shift());
    }

    initPeerConnection();
    requestMicrophoneAccess();

    // Если звонок уже начат, обновим UI
    {% if call_started %}
      updateUIOnCallStart();
    {% endif %}
    updateCallStatus("Ожидание соединения...");
  };

  ws.onmessage = async (event) => {
    const data = JSON.parse(event.data);
    if (data.sender === userId) return; // игнорировать свои сообщения

    switch (data.type) {
      case 'offer':
        if (!peerConnection) {
          initPeerConnection();
        }
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        sendMessage({ type: 'answer', answer: peerConnection.localDescription, sender: userId });
        break;
      case 'answer':
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        break;
      case 'ice-candidate':
        await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        break;
      case 'hangup':
        endCall();
        break;
    }
  };

  // Инициализация PeerConnection
  function initPeerConnection() {
    peerConnection = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

    peerConnection.onicecandidate = (event) => {
      if (event.candidate) {
        sendMessage({ type: 'ice-candidate', candidate: event.candidate, sender: userId });
      }
    };

    peerConnection.ontrack = (event) => {
      const remoteAudio = document.getElementById('remoteAudio');
      if (remoteAudio.srcObject !== event.streams[0]) {
        remoteAudio.srcObject = event.streams[0];
        detectSpeaking(event.streams[0]);
      }
    };
  }

  // Запрос микрофона и добавление трека
  function requestMicrophoneAccess() {
    navigator.mediaDevices.getUserMedia({ audio: true, video: false })
      .then(stream => {
        localStream = stream;
        document.getElementById('localAudio').srcObject = stream;
        if (peerConnection) {
          stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
        }
      })
      .catch(error => {
        alert("Не удалось получить доступ к микрофону");
        console.error(error);
      });
  }

  // Обработчик для кнопки "Начать звонок"
  if (callBtn) {
    callBtn.onclick = () => {
      if (!peerConnection) {
        initPeerConnection();
      }
      navigator.mediaDevices.getUserMedia({ audio: true, video: false }).then(stream => {
        localStream = stream;
        document.getElementById('localAudio').srcObject = stream;
        stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

        peerConnection.createOffer()
          .then(offer => {
            return peerConnection.setLocalDescription(offer);
          })
          .then(() => {
            updateUIOnCallStart(); // Показываем "Скинуть" и "Выключить микрофон"
            updateCallStatus("Звонок идет...");
            sendMessage({ type: 'offer', offer: peerConnection.localDescription, sender: userId });
          })
          .catch(error => {
            alert("Ошибка при создании предложения");
            console.error(error);
          });
      }).catch(error => {
        alert("Не удалось получить доступ к микрофону");
        console.error(error);
      });
    };
  }

  // Обработчик для кнопки "Скинуть"
  if (cancelBtn) {
    cancelBtn.onclick = () => {
      endCall();
      sendMessage({ type: 'hangup', sender: userId });
      updateUIOnCallEnd();
    };
  }

  // Обработчик для кнопки "Выключить микрофон"
  if (muteBtn) {
    let micMuted = false;
    muteBtn.onclick = () => {
      if (!localStream) return;
      localStream.getAudioTracks().forEach(track => {
        track.enabled = !track.enabled;
      });
      micMuted = !micMuted;
      muteBtn.textContent = micMuted ? "Включить микрофон" : "Выключить микрофон";
    };
  }

  // Завершение звонка
  function endCall() {
    if (peerConnection) {
      peerConnection.close();
      peerConnection = null;
    }
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
    }
    document.getElementById('localAudio').srcObject = null;
    document.getElementById('remoteAudio').srcObject = null;
    alert('Звонок завершен');
    updateCallStatus("Звонок завершен");
  }

  // Детектор говорящего (упрощённый)
  function detectSpeaking(stream) {
    const context = new AudioContext();
    const source = context.createMediaStreamSource(stream);
    const analyser = context.createAnalyser();
    source.connect(analyser);
    analyser.fftSize = 512;
    const dataArray = new Uint8Array(analyser.fftSize);

    function analyze() {
      analyser.getByteTimeDomainData(dataArray);
      const rms = Math.sqrt(dataArray.reduce((sum, val) => sum + (val - 128) ** 2, 0) / dataArray.length);
      // Предположим, что говорящий — это текущий пользователь
      highlightSpeaker(userId);
      setTimeout(analyze, 1000);
    }
    analyze();
  }
</script>
{% endblock content %}